ä½ å·²ç»æœ‰äº†å¸¦è°ƒè¯•ä¿¡æ¯çš„ç¨‹åºï¼š
g++ -g exercise.cpp -o exercise.out -pthread

ğŸ§© ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨ gdb
gdb exercise.out
è¿›å…¥åä¼šçœ‹åˆ°ï¼š
(gdb) 


----------------------------------------------------------
rc@DESKTOP-NIB59HE:~/å®ç°å„ç§ç®—æ³•$ gdb exercise.out
GNU gdb (Ubuntu 9.2-0ubuntu1~20.04.2) 9.2
Copyright (C) 2020 Free Software Foundation, Inc.

(gdb) (gdb) run              # å¯åŠ¨ç¨‹åº
Undefined command: "".  Try "help".
(gdb) run              # å¯åŠ¨ç¨‹åº
Starting program: /home/rc/å®ç°å„ç§ç®—æ³•/exercise.out # å¯åŠ¨ç¨‹åº
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff7d9f700 (LWP 22828)]
Produced: 83
[New Thread 0x7ffff759e700 (LWP 22829)]
Consumed: 83
Produced: 86
Consumed: 86
Produced: 77
Consumed: 77
Produced: 15
^C
Thread 1 "exercise.out" received signal SIGINT, Interrupt.
__pthread_clockjoin_ex (threadid=140737351644928, thread_return=0x0, clockid=<optimized out>, abstime=<optimized out>, 
    block=<optimized out>) at pthread_join_common.c:145
145     pthread_join_common.c: No such file or directory.
(gdb) 
--------------------------------------------------------------------------------------------------------------------
(gdb) run
ğŸ”¹ æ„æ€ï¼š
è¿è¡Œå½“å‰åŠ è½½çš„ç¨‹åºï¼ˆexercise.outï¼‰
ä¼šé‡å¯ç¨‹åºï¼Œä» main() å¼€å§‹æ‰§è¡Œ
æ˜¯ gdb æœ€åŸºæœ¬çš„å‘½ä»¤ä¹‹ä¸€
--------------------------------------------------------------------------------------------------------------------
âœ… è¾“å‡ºï¼šå¯åŠ¨ç¨‹åºå¹¶é™„åŠ çº¿ç¨‹è°ƒè¯•æ”¯æŒ
Starting program: /home/rc/å®ç°å„ç§ç®—æ³•/exercise.out
å¯åŠ¨ç¨‹åºçš„è·¯å¾„ã€‚
è¯´æ˜ä½ çš„ç¨‹åºå·²ç»è¢«åŠ è½½ã€å‡†å¤‡å¼€å§‹è¿è¡Œã€‚

[Thread debugging using libthread_db enabled]
gdb åŠ è½½äº†ä¸“é—¨çš„åº“ libthread_dbï¼Œç”¨äºè°ƒè¯• pthread çº¿ç¨‹ç¨‹åºã€‚
âœ… è‡ªåŠ¨å®Œæˆï¼Œæ— éœ€æ‹…å¿ƒã€‚
--------------------------------------------------------------------------------------------------------------------
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1"
æŒ‡æ˜æ‰€ç”¨çš„è°ƒè¯•åº“å®é™…åŠ è½½çš„æ˜¯å“ªä¸ªåŠ¨æ€é“¾æ¥åº“ã€‚

--------------------------------------------------------------------------------------------------------------------
âœ… è¾“å‡ºï¼šçº¿ç¨‹å¯åŠ¨

[New Thread 0x7ffff7d9f700 (LWP 22828)]
Produced: 83
å¯åŠ¨äº†ä¸€ä¸ªæ–°çº¿ç¨‹ï¼ˆå°±æ˜¯ producerï¼‰

LWP æ˜¯ Linux Light Weight Processï¼ˆè½»é‡çº§çº¿ç¨‹ï¼‰

çº¿ç¨‹å·æ˜¯ 22828ï¼Œå†…æ ¸çº§çº¿ç¨‹

ç„¶å producer æ‰§è¡Œäº† printf("Produced: %d\n", buffer);

------------------------------------------------------------------------------------------------------------
âœ… ä½ æŒ‰ä¸‹äº† Ctrl+Cï¼Œgdb è¾“å‡ºï¼š
^C
Thread 1 "exercise.out" received signal SIGINT, Interrupt.
ä½ æ‰“æ–­äº†ç¨‹åºï¼ˆé€šå¸¸æ˜¯è¦æš‚åœè°ƒè¯•ã€æŸ¥çœ‹çŠ¶æ€ï¼‰
SIGINT ä¿¡å·æ˜¯ Ctrl+C åœ¨ Linux ä¸‹å‘å‡ºçš„ç»ˆæ­¢ä¿¡å·
__pthread_clockjoin_ex (threadid=140737351644928, ...)
at pthread_join_common.c:145

æ˜¾ç¤ºå½“å‰æš‚åœçš„ä½ç½®ï¼šä¸»çº¿ç¨‹ï¼ˆmainï¼‰æ­£åœ¨ç­‰å¾…å…¶ä»–çº¿ç¨‹ç»“æŸï¼ˆpthread_joinï¼‰
pthread_join æ˜¯åœ¨ main() ä¸­ç­‰å¾…ç”Ÿäº§è€…/æ¶ˆè´¹è€…çº¿ç¨‹å®Œæˆçš„å‡½æ•°

------------------------------------------------------------------------------------------------------------
âœ… ä»€ä¹ˆæ˜¯ libthread_db.soï¼Ÿ
libthread_db.so æ˜¯ Linux ä¸Šä¸“é—¨ç”¨äº GDB è°ƒè¯• pthread å¤šçº¿ç¨‹ç¨‹åºçš„å…±äº«åº“ï¼ˆè°ƒè¯•æ”¯æŒåº“ï¼‰ã€‚

å®ƒä¸æ˜¯ä½ ç¨‹åºç›´æ¥é“¾æ¥çš„åº“ï¼Œè€Œæ˜¯ gdb ç”¨æ¥â€œçœ‹æ¸…æ¥šçº¿ç¨‹å†…éƒ¨çŠ¶æ€â€çš„â€œå¤–æŒ‚çœ¼é•œâ€ã€‚

âœ… â€œhostâ€ æ˜¯ä»€ä¹ˆï¼Ÿ
host = å½“å‰è¿è¡Œ GDB çš„ä¸»æœºæ“ä½œç³»ç»Ÿç¯å¢ƒï¼ˆå³æœ¬åœ° Linuxï¼‰
è¡¨ç¤ºï¼šä½ æœ¬åœ°ç³»ç»Ÿ /lib/x86_64-linux-gnu/ ä¸­çš„è¿™ä¸ªåº“æ­£è¢«ç”¨æ¥æ”¯æŒ gdb åˆ†æçº¿ç¨‹ã€‚


------------------------------------------------------------------------------------------------------------
 ä¸ºä»€ä¹ˆè¦è¿™ä¸ªåº“ï¼Ÿ
POSIX çº¿ç¨‹ï¼ˆpthreadï¼‰æ˜¯å†…æ ¸è°ƒåº¦çš„å®ä½“ï¼ˆLWPï¼‰ï¼Œä½† GDB ä¸ç›´æ¥èƒ½â€œçœ‹æ‡‚â€çº¿ç¨‹ç»“æ„ã€‚
æ‰€ä»¥ GDB å€ŸåŠ© libthread_db æ¥è·å¾—ä»¥ä¸‹ä¿¡æ¯ï¼š
æ´»åŠ¨çº¿ç¨‹åˆ—è¡¨
æ¯ä¸ªçº¿ç¨‹çš„æ ˆã€å¯„å­˜å™¨
å“ªä¸ªçº¿ç¨‹å¡åœ¨å“ªä¸ªé”ã€åœ¨å“ªä¸ªç³»ç»Ÿè°ƒç”¨
[gdb] â† ä½¿ç”¨ â†’ [libthread_db.so.1] â† è§£é‡Š â†’ [çº¿ç¨‹åº“çš„å†…éƒ¨çŠ¶æ€ï¼ˆlibpthread.soï¼‰]
------------------------------------------------------------------------------------------------------------
âœ… 2. SIGINT æ˜¯é€šè¿‡çº¿ç¨‹å‘å‡ºçš„å—ï¼Ÿpthread_join æ˜¯æ€ä¹ˆå¡ä½çš„ï¼Ÿ
âœ… é¦–å…ˆæ˜ç¡®ï¼š
SIGINT æ˜¯ä¸€ä¸ªä¿¡å·ï¼ˆSignalï¼‰
Ctrl+C æ˜¯ shell å‘é€ç»™å‰å°è¿›ç¨‹ç»„çš„ SIGINT ä¿¡å·
ä¸ç®¡ä½ ç”¨ä¸ç”¨å¤šçº¿ç¨‹ï¼Œéƒ½ä¼šè§¦å‘è¿™ä¸ªä¿¡å·ã€‚
------------------------------------------------------------------------------------------------------------
ä¿¡å·æ˜¯è¿›ç¨‹çº§åˆ«çš„ï¼Œå†…æ ¸ç›´æ¥å‘ç»™è¿›ç¨‹ï¼ˆæ— è§†çº¿ç¨‹ç»†èŠ‚ï¼‰
------------------------------------------------------------------------------------------------------------
ğŸ“Œ gdb ä¸ºä»€ä¹ˆèƒ½å‘Šè¯‰ä½  pthread_join_common.c:145ï¼Ÿ
å› ä¸ºä½ ç”¨äº† -g ç¼–è¯‘é€‰é¡¹ï¼ŒGDB èƒ½è§£æå¸¦æºç è·¯å¾„çš„ç³»ç»Ÿåº“ã€‚

å¦‚æœåº“æ˜¯ -g ç¼–è¯‘çš„ï¼Œå°±èƒ½çœ‹åˆ°æºç çº§ä¿¡æ¯ã€‚

------------------------------------------------------------------------------------------------------------
âœ… 1. æ˜¯çš„ï¼Œè¿™æ˜¯çœŸå®å­˜åœ¨çš„ç³»ç»Ÿæºç æ–‡ä»¶
pthread_join_common.c æ˜¯ glibc åº“ä¸­çš„æºæ–‡ä»¶
Glibc æ˜¯ Linux ä¸Š C æ ‡å‡†åº“ï¼ˆlibcï¼‰ã€çº¿ç¨‹åº“ï¼ˆlibpthreadï¼‰çš„å®ç°è€…
ä½ è°ƒç”¨ pthread_join()ï¼Œå®é™…ä¸Šæ‰§è¡Œçš„æ˜¯ glibc ä¸­çš„çœŸå® C å‡½æ•°
ğŸ“ æ‰€ä»¥ä½ çœ‹åˆ°çš„ pthread_join_common.c:145 æŒ‡çš„æ˜¯ glibc ä¸­è¿™ä¸ªæ–‡ä»¶ç¬¬ 145 è¡Œçš„ä»£ç ã€‚

------------------------------------------------------------------------------------------------------------
ğŸ§© 6. set scheduler-locking on â€” é”å®šå½“å‰çº¿ç¨‹
é»˜è®¤ GDB ä¼šè°ƒåº¦å¤šä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚

(gdb) set scheduler-locking on
è¡¨ç¤ºåªè®©å½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œå…¶ä½™å…¨éƒ¨æŒ‚èµ·ï¼Œé€‚åˆåˆ†æ race conditionï¼ˆç«æ€ï¼‰

------------------------------------------------------------------------------------------------------------
ğŸ§© 7. finish â€” ç›´æ¥è·³å‡ºå½“å‰å‡½æ•°

(gdb) finish
è·³å‡ºå½“å‰å‡½æ•°ã€è¿”å›è°ƒç”¨è€…ï¼Œå¯ä»¥åŠ é€Ÿè°ƒè¯•ã€‚
------------------------------------------------------------------------------------------------------------
âœ… ä¸€ã€åŸºç¡€è°ƒè¯•å‘½ä»¤ï¼ˆæ¯ä¸ª C/C++ ç¨‹åºå‘˜å¿…ä¼šï¼‰
å‘½ä»¤	ä½œç”¨
run / r	å¯åŠ¨ç¨‹åº
break / b	è®¾ç½®æ–­ç‚¹ï¼ˆå‡½æ•°åã€æ–‡ä»¶:è¡Œå·ï¼‰
continue / c	ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹
next / n	å•æ­¥æ‰§è¡Œï¼ˆä¸è¿›å…¥å‡½æ•°ï¼‰
step / s	å•æ­¥æ‰§è¡Œï¼ˆè¿›å…¥å‡½æ•°ï¼‰
print x / p x	æ‰“å°å˜é‡ x çš„å€¼
list / l	æŸ¥çœ‹æºä»£ç 
quit / q	é€€å‡º gdb
---------------------------------
âœ… æ¯é¡¹é‡ç‚¹ä¸¾ä¾‹ï¼ˆéƒ¨åˆ†é«˜é¢‘æŠ€å·§ï¼‰
âœ… watch buffer ç›‘æ§å†™å…¥

(gdb) watch buffer
(gdb) run
ç¨‹åºä¸€æ—¦ä¿®æ”¹ bufferï¼ˆæ— è®ºå“ªä¸ªçº¿ç¨‹ï¼‰ï¼Œç«‹å³æš‚åœï¼š


Hardware watchpoint 1: buffer
Old value = 42
New value = 50
âœ… æ¡ä»¶æ–­ç‚¹ condition

(gdb) break producer
(gdb) condition 1 buffer == 88
åªæœ‰å½“ buffer == 88 æ—¶æ‰æ–­ä¸‹ï¼Œéå¸¸é€‚åˆè°ƒè¯•ä¸ç¨³å®šçš„ç«æ€å€¼ã€‚

âœ… info threads + bt

(gdb) info threads
(gdb) thread 3
(gdb) bt
çœ‹ç¬¬ 3 ä¸ªçº¿ç¨‹æ˜¯å¦å¡åœ¨ sem_waitã€æ­»é”ã€sleep ç­‰åœ°æ–¹ã€‚

âœ… xï¼ˆexamine memoryï¼‰

(gdb) x/4x &buffer
æŸ¥çœ‹å†…å­˜ä¸­å˜é‡ buffer çš„åå…­è¿›åˆ¶å†…å®¹ã€‚

âœ… æ±‡ç¼–åˆ†æï¼š

(gdb) disassemble producer
æŸ¥çœ‹å‡½æ•°æ±‡ç¼–ç»“æ„ï¼Œåˆ†æä¼˜åŒ–ã€æŒ‡ä»¤çº§è¡Œä¸ºã€‚

âœ… call æ³¨å…¥è°ƒç”¨ï¼š

(gdb) call printf("X = %d\n", buffer)
ç›´æ¥è¿è¡Œå‡½æ•°è°ƒç”¨è°ƒè¯•è¾“å‡ºï¼Œä¸æ”¹ä»£ç ã€‚

âœ… layoutï¼ˆå›¾å½¢ TUIï¼‰

(gdb) layout src
(gdb) layout asm
å…¨å±æ˜¾ç¤ºæºç  + æ±‡ç¼–ï¼Œé€‚åˆäº¤äº’å¼å¯è§†åŒ–è°ƒè¯•ã€‚

-------------------------------------------------------
åˆçº§	æ–­ç‚¹ + æ‰“å° + å•æ­¥	break, run, next, print, quit
ä¸­çº§	æ¡ä»¶ + watch + å¤šçº¿ç¨‹	watch, condition, info threads, bt
é«˜çº§	æ±‡ç¼–ã€å¯„å­˜å™¨ã€patch	disas, x, info reg, set *(...) =
å®æˆ˜	core dump, å…±äº«åº“è°ƒè¯•	gdb ./a.out core, info sharedlibrary
è‡ªåŠ¨	.gdbinit, define, source	è‡ªåŠ¨è°ƒè¯•è„šæœ¬ã€è‡ªå®šä¹‰å‘½ä»¤
-----------------------------------------------------------





